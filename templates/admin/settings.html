{% extends "base/base.html" %}

{% block title %}System Settings - Muni-Info Admin{% endblock %}

{% block page_title %}System Settings{% endblock %}
{% block page_description %}Configure system-wide settings and preferences{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-outline-primary" onclick="refreshStats()">
    <i class="fas fa-sync-alt me-2"></i>Refresh Stats
</button>
{% endblock %}

{% block main_content %}
<div class="row">
    <!-- System Statistics -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>System Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="bg-primary text-white p-3 rounded">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-users fa-2x opacity-75"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="small">Total Users</div>
                                    <div class="h4 mb-0">{{ system_stats.total_users }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="bg-success text-white p-3 rounded">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-user-check fa-2x opacity-75"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="small">Active Users</div>
                                    <div class="h4 mb-0">{{ system_stats.active_users }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="bg-info text-white p-3 rounded">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="small">Total Complaints</div>
                                    <div class="h4 mb-0">{{ system_stats.total_complaints }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="bg-warning text-white p-3 rounded">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-server fa-2x opacity-75"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="small">System Uptime</div>
                                    <div class="h6 mb-0">{{ system_stats.system_uptime }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <!-- System Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>System Configuration
                </h5>
            </div>
            <div class="card-body">
                <form id="systemSettingsForm">
                    <div class="mb-3">
                        <label for="system_name" class="form-label">System Name</label>
                        <input type="text" class="form-control" id="system_name" name="system_name" 
                               value="Muni-Info Municipal Services">
                    </div>
                    
                    <div class="mb-3">
                        <label for="admin_email" class="form-label">Administrator Email</label>
                        <input type="email" class="form-control" id="admin_email" name="admin_email" 
                               value="admin@municipality.gov.za">
                    </div>
                    
                    <div class="mb-3">
                        <label for="session_timeout" class="form-label">Session Timeout (minutes)</label>
                        <select class="form-select" id="session_timeout" name="session_timeout">
                            <option value="30">30 minutes</option>
                            <option value="60" selected>1 hour</option>
                            <option value="120">2 hours</option>
                            <option value="240">4 hours</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto_assign_complaints" 
                                   name="auto_assign_complaints" checked>
                            <label class="form-check-label" for="auto_assign_complaints">
                                Auto-assign complaints to departments
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="email_notifications" 
                                   name="email_notifications" checked>
                            <label class="form-check-label" for="email_notifications">
                                Send email notifications
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="sms_notifications" 
                                   name="sms_notifications">
                            <label class="form-check-label" for="sms_notifications">
                                Send SMS notifications
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Settings
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Backup & Maintenance -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tools me-2"></i>Backup & Maintenance
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <p class="text-muted">
                        Regular system maintenance and data backups are essential for system reliability.
                    </p>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-success" onclick="createBackup()">
                        <i class="fas fa-download me-2"></i>Create Data Backup
                    </button>
                    
                    <button type="button" class="btn btn-outline-warning" onclick="clearCache()">
                        <i class="fas fa-broom me-2"></i>Clear System Cache
                    </button>
                    
                    <button type="button" class="btn btn-outline-info" onclick="viewLogs()">
                        <i class="fas fa-file-alt me-2"></i>View System Logs
                    </button>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Last backup: Never (Configure automated backups in production)
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <!-- Security Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>Security Settings
                </h5>
            </div>
            <div class="card-body">
                <form id="securitySettingsForm">
                    <div class="mb-3">
                        <label for="password_policy" class="form-label">Minimum Password Length</label>
                        <select class="form-select" id="password_policy" name="password_policy">
                            <option value="6">6 characters</option>
                            <option value="8" selected>8 characters</option>
                            <option value="10">10 characters</option>
                            <option value="12">12 characters</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="login_attempts" class="form-label">Max Login Attempts</label>
                        <select class="form-select" id="login_attempts" name="login_attempts">
                            <option value="3">3 attempts</option>
                            <option value="5" selected>5 attempts</option>
                            <option value="10">10 attempts</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="require_2fa" name="require_2fa">
                            <label class="form-check-label" for="require_2fa">
                                Require two-factor authentication
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="log_activities" 
                                   name="log_activities" checked>
                            <label class="form-check-label" for="log_activities">
                                Log user activities
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="force_password_reset" 
                                   name="force_password_reset">
                            <label class="form-check-label" for="force_password_reset">
                                Force password reset every 90 days
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-shield-alt me-2"></i>Update Security
                    </button>
                </form>
            </div>
        </div>
        
        <!-- API Configuration -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plug me-2"></i>API Configuration
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="twilio_status" class="form-label">Twilio WhatsApp Status</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-circle text-success"></i>
                        </span>
                        <input type="text" class="form-control" value="Connected" readonly>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="google_maps_status" class="form-label">Google Maps API Status</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-circle text-warning"></i>
                        </span>
                        <input type="text" class="form-control" value="Optional - Not configured" readonly>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="mongodb_status" class="form-label">Database Status</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-circle text-success"></i>
                        </span>
                        <input type="text" class="form-control" value="Connected" readonly>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> API configurations are managed through environment variables. 
                    Contact your system administrator to update API keys and connection strings.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// System settings form submission
document.getElementById('systemSettingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    for (let [key, value] of formData.entries()) {
        if (this.elements[key].type === 'checkbox') {
            data[key] = this.elements[key].checked;
        } else {
            data[key] = value;
        }
    }
    
    fetch('{{ url_for("admin.update_system_settings") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('success', result.message);
        } else {
            showAlert('danger', result.error || 'An error occurred');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred while updating settings');
    });
});

// Security settings form submission
document.getElementById('securitySettingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    for (let [key, value] of formData.entries()) {
        if (this.elements[key].type === 'checkbox') {
            data[key] = this.elements[key].checked;
        } else {
            data[key] = value;
        }
    }
    
    data.settings_type = 'security';
    
    fetch('{{ url_for("admin.update_system_settings") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('success', 'Security settings updated successfully');
        } else {
            showAlert('danger', result.error || 'An error occurred');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred while updating security settings');
    });
});

// Maintenance functions
function refreshStats() {
    showAlert('info', 'Refreshing system statistics...');
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function createBackup() {
    if (confirm('This will create a backup of all system data. Continue?')) {
        showAlert('info', 'Creating backup... This may take a few minutes.');
        // In production, this would trigger an actual backup process
        setTimeout(() => {
            showAlert('success', 'Backup created successfully!');
        }, 3000);
    }
}

function clearCache() {
    if (confirm('This will clear all cached data. Continue?')) {
        showAlert('info', 'Clearing system cache...');
        // In production, this would clear actual cache
        setTimeout(() => {
            showAlert('success', 'System cache cleared successfully!');
        }, 2000);
    }
}

function viewLogs() {
    // In production, this would open a logs viewer or download logs
    showAlert('info', 'System logs functionality available in production environment');
}

function showAlert(type, message) {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => {
        if (alert.classList.contains('alert-info') || 
            alert.classList.contains('alert-success') || 
            alert.classList.contains('alert-danger')) {
            alert.remove();
        }
    });
    
    // Create new alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the main content
    const mainContent = document.querySelector('main .page-header');
    mainContent.insertAdjacentElement('afterend', alertDiv);
    
    // Auto-dismiss info alerts after 3 seconds
    if (type === 'info') {
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }
}
</script>
{% endblock %}