{% extends "portal/base.html" %}

{% block title %}Submit Complaint - Government Portal{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Government-style breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('portal.index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('portal.services') }}">Services</a></li>
            <li class="breadcrumb-item active" aria-current="page">Submit Complaint</li>
        </ol>
    </nav>
    
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Clear government-style header -->
            <div class="page-header mb-4 text-center">
                <h1 class="h2 text-primary mb-2">Submit a Service Complaint</h1>
                <p class="text-muted">Report municipal service issues and track their resolution</p>
            </div>
            
            <!-- Information panel with plain language -->
            <div class="alert alert-info mb-4" role="region" aria-labelledby="info-heading">
                <h5 id="info-heading" class="alert-heading">
                    <i class="fas fa-info-circle me-2" aria-hidden="true"></i>Before you start
                </h5>
                <ul class="mb-0">
                    <li><strong>Have your contact details ready</strong> - We need your phone number to send updates</li>
                    <li><strong>Describe the problem clearly</strong> - Include location and when it started</li>
                    <li><strong>You will get a reference number</strong> - Use this to track your complaint</li>
                    <li><strong>For emergencies</strong> - Call the numbers on our <a href="{{ url_for('portal.emergency_services') }}" class="alert-link">Emergency Services page</a></li>
                </ul>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0">
                        <i class="fas fa-edit me-2" aria-hidden="true"></i>Complaint Details
                    </h2>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted mb-4">
                        <strong>All fields marked with * are required.</strong> 
                        The more information you provide, the faster we can help you.
                    </p>
                    
                    <form method="POST" enctype="multipart/form-data" id="complaint-form">
                        <fieldset>
                            <legend class="sr-only">Contact Information</legend>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="phone_number" class="form-label">Your phone number <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="phone_number" name="phone_number" 
                                           placeholder="example: 012 345 6789" required 
                                           aria-describedby="phone-help">
                                    <div id="phone-help" class="form-text">We will send SMS updates about your complaint to this number</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="complaint_type" class="form-label">What type of problem is this? <span class="text-danger">*</span></label>
                                    <select class="form-select" id="complaint_type" name="complaint_type" required
                                            aria-describedby="type-help">
                                        <option value="">Choose the service type</option>
                                        <option value="Water">Water and sewage</option>
                                        <option value="Electricity">Electricity and power</option>
                                        <option value="Sanitation">Waste and recycling</option>
                                        <option value="Roads">Roads and transport</option>
                                        <option value="Housing">Housing and buildings</option>
                                        <option value="Parks">Parks and recreation</option>
                                        <option value="Other">Something else</option>
                                    </select>
                                    <div id="type-help" class="form-text">Choose the category that best matches your problem</div>
                                </div>
                            </div>
                        </fieldset>
                        
                        <fieldset>
                            <legend class="sr-only">Problem Details</legend>
                            <div class="mb-3">
                                <label for="priority" class="form-label">How urgent is this problem?</label>
                                <select class="form-select" id="priority" name="priority" 
                                        aria-describedby="priority-help">
                                    <option value="low">Low priority - Can wait a week</option>
                                    <option value="medium" selected>Normal priority - Needs attention soon</option>
                                    <option value="high">High priority - Affects daily life</option>
                                    <option value="urgent">Urgent - Safety risk or emergency</option>
                                </select>
                                <div id="priority-help" class="form-text">
                                    <strong>Choose 'Urgent' only for safety emergencies.</strong> 
                                    For life-threatening emergencies, call 10111 (Police) or 10177 (Fire/Medical).
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="description" class="form-label">Tell us about the problem <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="description" name="description" rows="6" 
                                          required aria-describedby="description-help"
                                          placeholder="Example: The streetlight outside 123 Main Street has been broken for 2 weeks. The light post is leaning and the glass is cracked. This makes it dangerous to walk there at night."></textarea>
                                <div id="description-help" class="form-text">
                                    <strong>Include:</strong> 
                                    What is the problem? | Where exactly is it? | When did it start? | How does it affect you?
                                </div>
                            </div>
                            
                            <!-- Photo/Video Upload Section -->
                            <div class="mb-4">
                                <label for="media_files" class="form-label">Add photos or videos (optional)</label>
                                <div class="upload-area border border-2 border-dashed rounded p-4 text-center mb-3" 
                                     id="upload-area" onclick="document.getElementById('media_files').click();">
                                    <div id="upload-placeholder">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                        <p class="mb-2"><strong>Click to select files</strong> or drag and drop</p>
                                        <p class="text-muted small mb-0">
                                            Photos: JPG, PNG, GIF (max 10MB each)<br>
                                            Videos: MP4, MOV, AVI (max 100MB each)<br>
                                            Maximum 5 files total
                                        </p>
                                    </div>
                                    <div id="upload-preview" class="d-none">
                                        <div id="file-list" class="row g-2"></div>
                                    </div>
                                </div>
                                <input type="file" class="form-control d-none" id="media_files" name="media_files" 
                                       multiple accept="image/*,video/*" aria-describedby="media-help">
                                <div id="media-help" class="form-text">
                                    Photos and videos help us understand the problem better and resolve it faster.
                                </div>
                            </div>
                        </fieldset>
                        
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="location_consent" required>
                                <label class="form-check-label" for="location_consent">
                                    I consent to sharing my location information to help with complaint resolution
                                </label>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-3 justify-content-center flex-wrap">
                            <button type="submit" class="btn btn-primary btn-lg px-4">
                                <i class="fas fa-paper-plane me-2"></i>Submit Complaint
                            </button>
                            <a href="{{ url_for('portal.index') }}" class="btn btn-outline-secondary btn-lg px-4">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Help Information -->
            <div class="row mt-5">
                <div class="col-md-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title text-primary">
                                <i class="fas fa-info-circle me-2"></i>
                                What happens next?
                            </h5>
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2 d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>You'll receive a reference number</span>
                                </li>
                                <li class="mb-2 d-flex align-items-center">
                                    <i class="fas fa-sms text-primary me-2"></i>
                                    <span>SMS confirmation will be sent</span>
                                </li>
                                <li class="mb-2 d-flex align-items-center">
                                    <i class="fas fa-search text-info me-2"></i>
                                    <span>Your complaint will be reviewed</span>
                                </li>
                                <li class="mb-2 d-flex align-items-center">
                                    <i class="fas fa-bell text-warning me-2"></i>
                                    <span>You'll receive status updates</span>
                                </li>
                                <li class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span>Resolution notification when complete</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title text-primary">
                                <i class="fas fa-clock me-2"></i>
                                Response Times
                            </h5>
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2 d-flex align-items-center justify-content-between">
                                    <span>
                                        <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                                        <span class="badge bg-danger">Urgent</span>
                                    </span>
                                    <span>Within 2 hours</span>
                                </li>
                                <li class="mb-2 d-flex align-items-center justify-content-between">
                                    <span>
                                        <i class="fas fa-exclamation-circle text-warning me-2"></i>
                                        <span class="badge bg-warning text-dark">High</span>
                                    </span>
                                    <span>Within 24 hours</span>
                                </li>
                                <li class="mb-2 d-flex align-items-center justify-content-between">
                                    <span>
                                        <i class="fas fa-minus-circle text-info me-2"></i>
                                        <span class="badge bg-info">Medium</span>
                                    </span>
                                    <span>Within 3 days</span>
                                </li>
                                <li class="d-flex align-items-center justify-content-between">
                                    <span>
                                        <i class="fas fa-circle text-success me-2"></i>
                                        <span class="badge bg-success">Low</span>
                                    </span>
                                    <span>Within 7 days</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-detect location if user gives permission
document.addEventListener('DOMContentLoaded', function() {
    const locationConsent = document.getElementById('location_consent');
    
    locationConsent.addEventListener('change', function() {
        if (this.checked && navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                console.log('Location detected:', position.coords.latitude, position.coords.longitude);
                // Could store coordinates to include with complaint
            }, function(error) {
                console.log('Location detection failed:', error);
            });
        }
    });
});

// File upload handling
let selectedFiles = [];
const maxFiles = 5;

document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('media_files');
    const uploadArea = document.getElementById('upload-area');
    const uploadPlaceholder = document.getElementById('upload-placeholder');
    const uploadPreview = document.getElementById('upload-preview');
    const fileList = document.getElementById('file-list');

    // Handle file input change
    fileInput.addEventListener('change', handleFileSelect);

    // Handle drag and drop
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('bg-light');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('bg-light');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('bg-light');
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });

    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        handleFiles(files);
    }

    function handleFiles(files) {
        // Check total file count
        if (selectedFiles.length + files.length > maxFiles) {
            alert(`Maximum ${maxFiles} files allowed. Currently selected: ${selectedFiles.length}`);
            return;
        }

        files.forEach(file => {
            if (validateFile(file)) {
                selectedFiles.push(file);
                addFilePreview(file);
            }
        });

        updateUploadDisplay();
    }

    function validateFile(file) {
        const maxImageSize = 10 * 1024 * 1024; // 10MB
        const maxVideoSize = 100 * 1024 * 1024; // 100MB
        const allowedImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];
        const allowedVideoTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/wmv', 'video/flv', 'video/webm', 'video/3gpp'];

        if (allowedImageTypes.includes(file.type)) {
            if (file.size > maxImageSize) {
                alert(`Image file "${file.name}" is too large. Maximum size: 10MB`);
                return false;
            }
        } else if (allowedVideoTypes.includes(file.type)) {
            if (file.size > maxVideoSize) {
                alert(`Video file "${file.name}" is too large. Maximum size: 100MB`);
                return false;
            }
        } else {
            alert(`File "${file.name}" has an unsupported format.`);
            return false;
        }

        return true;
    }

    function addFilePreview(file) {
        const fileId = 'file_' + Date.now() + Math.random().toString(36).substr(2, 9);
        const isImage = file.type.startsWith('image/');
        const isVideo = file.type.startsWith('video/');

        const previewHtml = `
            <div class="col-md-4 mb-2" data-file-id="${fileId}">
                <div class="card">
                    <div class="card-body p-2 text-center">
                        ${isImage ? '<i class="fas fa-image fa-2x text-primary mb-1"></i>' : 
                          isVideo ? '<i class="fas fa-video fa-2x text-success mb-1"></i>' : 
                          '<i class="fas fa-file fa-2x text-secondary mb-1"></i>'}
                        <p class="small mb-1 text-truncate" title="${file.name}">${file.name}</p>
                        <p class="small text-muted mb-1">${formatFileSize(file.size)}</p>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile('${fileId}')">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                </div>
            </div>
        `;

        fileList.insertAdjacentHTML('beforeend', previewHtml);
    }

    function updateUploadDisplay() {
        if (selectedFiles.length > 0) {
            uploadPlaceholder.classList.add('d-none');
            uploadPreview.classList.remove('d-none');
        } else {
            uploadPlaceholder.classList.remove('d-none');
            uploadPreview.classList.add('d-none');
        }
    }

    window.removeFile = function(fileId) {
        const fileElement = document.querySelector(`[data-file-id="${fileId}"]`);
        const fileName = fileElement.querySelector('p').textContent;
        
        // Remove from selectedFiles array
        selectedFiles = selectedFiles.filter(file => file.name !== fileName);
        
        // Remove from DOM
        fileElement.remove();
        
        updateUploadDisplay();
    };

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
});

// Form validation and submission
document.querySelector('#complaint-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const phoneNumber = document.getElementById('phone_number').value;
    const phoneRegex = /^[\+]?[0-9\s\-\(\)]{10,}$/;
    
    if (!phoneRegex.test(phoneNumber)) {
        alert('Please enter a valid phone number');
        return false;
    }

    // Create FormData to handle file uploads
    const formData = new FormData(this);
    
    // Add selected files to FormData
    selectedFiles.forEach((file, index) => {
        formData.append('media_files', file);
    });

    // Show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
    submitBtn.disabled = true;

    // Submit form
    fetch(this.action || window.location.pathname, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            return response.text().then(html => {
                document.body.innerHTML = html;
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while submitting your complaint. Please try again.');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});
</script>
{% endblock %}